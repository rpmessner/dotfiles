# yaml-language-server: $schema=https://taskfile.dev/schema.json
#
version: 3

vars:
  TPM_DIR: ~/.local/share/tmux/plugins/tpm

tasks:
  reload:
    desc: Reload Tmux Configuration
    status:
      - '[ -z "$TMUX" ]'
    cmds:
      - cmd: tmux source-file ~/.config/tmux/tmux.conf
        silent: true
      - cmd: tmux display-message 'tmux.conf reloaded'
        silent: true
      - cmd: echo "Tmux Config Reloaded!"
        silent: true

  plugins:manager:install:
    desc: Install TPM (if not already installed)
    summary: |
      Install TPM (if not already installed)

      To force run with -f
    status:
      - test -d {{.TPM_DIR}}
    cmd: git clone https://github.com/tmux-plugins/tpm {{.TPM_DIR}}

  plugins:install:
    desc: Install Tmux Plugins
    status:
      - '[ -z "$TMUX" ]'
    cmds:
      - task: plugins:manager:install
      - task: reload
      - cmd: '{{.TPM_DIR}}/bin/install_plugins'
        silent: true
      - task: reload

  plugins:update:
    desc: Update Tmux Plugins
    status:
      - '[ -z "$TMUX" ]'
    cmds:
      - task: reload
      - cmd: '{{.TPM_DIR}}/bin/update_plugins app'
        silent: true

  plugins:clean:
    desc: Clean Tmux Plugins
    status:
      - '[ -z "$TMUX" ]'
    cmds:
      - task: reload
      - cmd: '{{.TPM_DIR}}/bin/clean_plugins'
        silent: true

  sync:
    desc: Install, updates and cleans plugins
    status:
      - '[ -z "$TMUX" ]'
    cmds:
      - task: plugins:clean
      - task: plugins:install
      - task: plugins:update

  airmux:install:
    desc: Install airmux (tmux session manager)
    summary: |
      Install airmux (tmux session manager)

      Airmux is a tmux session manager written in Rust that allows you to
      create and manage tmux sessions via configuration files.

      Requires Rust/cargo to be installed.
    status:
      - command -v airmux
    cmds:
      - cmd: |
          if ! command -v cargo &>/dev/null; then
            echo "âš ï¸  Cargo not found. Installing Rust first..."
            asdf plugin add rust https://github.com/asdf-community/asdf-rust.git || true
            asdf install rust latest
            asdf global rust latest
            # Reload shell to get cargo in PATH
            export PATH="$HOME/.asdf/installs/rust/$(asdf current rust | awk '{print $2}')/bin:$PATH"
          fi
          echo "ğŸ“¦ Installing airmux via cargo..."
          cargo install airmux
          echo "âœ… Airmux installed successfully!"

  airmux:update:
    desc: Update airmux to the latest version
    cmds:
      - cmd: |
          if command -v cargo &>/dev/null; then
            echo "ğŸ“¦ Updating airmux..."
            cargo install airmux --force
            echo "âœ… Airmux updated successfully!"
          else
            echo "âŒ Cargo not found. Cannot update airmux."
            exit 1
          fi
