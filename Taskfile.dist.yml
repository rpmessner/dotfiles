# yaml-language-server: $schema=https://taskfile.dev/schema.json
#
# Main Taskfile - Orchestrator
# ============================================================
# This is the root Taskfile that coordinates all dotfiles automation.
# It includes specialized taskfiles for different tools and provides
# convenient aliases for common operations.
#
# Entry points:
#   - task install: Complete installation (after setup.sh bootstrap)
#   - task sync:    Update configurations and tool versions
#   - task -l:      List all available tasks
#
# Architecture:
#   - This file defines top-level tasks and includes
#   - Implementation lives in taskfiles/ directory
#   - Core installation logic is in taskfiles/dotfiles.yml
#
version: 3

includes:
  asdf:
    aliases: [a]
    taskfile: ./taskfiles/asdf.yml

  bat:
    taskfile: ./taskfiles/bat.yml

  brew:
    aliases: [b]
    taskfile: ./taskfiles/brew.yml

  ci:
    taskfile: ./taskfiles/ci.yml

  comp:
    aliases: [c, completions]
    taskfile: ./taskfiles/completions.yml

  dot:
    aliases: [dots]
    taskfile: ./taskfiles/dotfiles.yml

  fonts:
    taskfile: ./taskfiles/fonts.yml

  gh:
    aliases: [github]
    taskfile: ./taskfiles/github.yml

  go:
    taskfile: ./taskfiles/go.yml

  lint:
    taskfile: ./taskfiles/lint.yml

  mac:
    taskfile: ./taskfiles/mac.yml

  nvim:
    taskfile: ./taskfiles/nvim.yml

  node:
    taskfile: ./taskfiles/node.yml

  python:
    taskfile: ./taskfiles/python.yml

  rust:
    taskfile: ./taskfiles/rust.yml

  shell:
    aliases: [sh]
    taskfile: ./taskfiles/shell.yml

  tmux:
    aliases: [t]
    taskfile: ./taskfiles/tmux.yml

  wezterm:
    aliases: [wez]
    taskfile: ./taskfiles/wezterm.yml

  zinit:
    taskfile: ./taskfiles/zinit.yml

tasks:
  default:
    cmd: task -l
    silent: true

  install:
    desc: An alias to dot:install
    cmds:
      - task: banner
      - task: dot:install

  sync:
    desc: An alias to dot:sync
    cmds:
      - task: banner
      - task: dot:sync

  install:sudo-touch-id:
    desc: Sets up touch id as sufficient sudo permission
    summary: Sets up touch id as sufficient sudo permission

      This survives OS updates after macOS Sonoma.

      Requires sudo.
    platforms: [darwin]
    cmds:
      - sed 's/^#auth/auth/' /etc/pam.d/sudo_local.template > /etc/pam.d/sudo_local

  fmt:
    desc: Formats all formattable files
    summary: An alias to dot:fmt
    aliases: [format]
    cmds:
      - task: dot:fmt

  doctor:
    desc: Verify system prerequisites and dotfiles health
    summary: |
      Checks system prerequisites and dotfiles installation status.

      Verifies:
      - Platform support (macOS or Ubuntu)
      - Required system tools (git, curl, etc.)
      - ASDF installation and tools
      - SSH key configuration
      - Symlink status

      Use this to diagnose issues before or after installation.
    cmds:
      - cmd: |
          echo "üîç Dotfiles Health Check"
          echo "========================"
          echo ""

          # Track failures
          FAILURES=0

          # Check platform
          echo "üìã Platform Check"
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          if [[ "$OS" == "darwin" ]]; then
            echo "  ‚úÖ macOS detected"
            PLATFORM="darwin"
          elif [[ -f /etc/lsb-release ]] && grep -q "Ubuntu" /etc/lsb-release; then
            echo "  ‚úÖ Ubuntu detected"
            PLATFORM="ubuntu"
          else
            echo "  ‚ùå Unsupported platform: $OS"
            FAILURES=$((FAILURES + 1))
            PLATFORM="unsupported"
          fi
          echo ""

          # Check required commands
          echo "üõ†Ô∏è  Required Commands"
          for cmd in git curl; do
            if command -v "$cmd" &>/dev/null; then
              echo "  ‚úÖ $cmd: $(command -v $cmd)"
            else
              echo "  ‚ùå $cmd: NOT FOUND"
              FAILURES=$((FAILURES + 1))
            fi
          done
          echo ""

          # Check ASDF
          echo "üì¶ ASDF Version Manager"
          if command -v asdf &>/dev/null; then
            echo "  ‚úÖ asdf: $(asdf version)"

            # Check for installed tools
            if asdf current &>/dev/null; then
              echo "  ‚úÖ Tools from .tool-versions:"
              asdf current | sed 's/^/    /'
            fi
          else
            echo "  ‚ö†Ô∏è  asdf: NOT INSTALLED (will be installed by setup.sh)"
          fi
          echo ""

          # Check SSH keys
          echo "üîë SSH Configuration"
          if [[ -f ~/.ssh/id_rsa ]] || [[ -f ~/.ssh/id_ed25519 ]]; then
            echo "  ‚úÖ SSH key found"
            if ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
              echo "  ‚úÖ GitHub SSH access verified"
            else
              echo "  ‚ö†Ô∏è  GitHub SSH access not verified (may need key setup)"
            fi
          else
            echo "  ‚ö†Ô∏è  No SSH key found in ~/.ssh/"
            echo "     You may need to generate one for git operations"
          fi
          echo ""

          # Check if dotfiles are symlinked
          echo "üîó Dotfiles Symlinks"
          if [[ -L ~/.zshrc ]] && [[ -L ~/.gitconfig ]]; then
            echo "  ‚úÖ Core dotfiles are symlinked"
          else
            echo "  ‚ö†Ô∏è  Dotfiles not yet symlinked (run 'task install')"
          fi
          echo ""

          # macOS specific checks
          if [[ "$PLATFORM" == "darwin" ]]; then
            echo "üçé macOS Specific"
            if command -v brew &>/dev/null; then
              echo "  ‚úÖ Homebrew: $(brew --version | head -1)"
            else
              echo "  ‚ö†Ô∏è  Homebrew: NOT INSTALLED (will be installed by setup.sh)"
            fi
            echo ""
          fi

          # Ubuntu specific checks
          if [[ -f /etc/lsb-release ]] && grep -q "Ubuntu" /etc/lsb-release; then
            echo "üêß Ubuntu Specific"
            echo "  ‚úÖ apt: $(apt --version | head -1)"
            echo ""
          fi

          # Summary
          echo "üìä Summary"
          if [[ $FAILURES -eq 0 ]]; then
            echo "  ‚úÖ All critical checks passed!"
            echo ""
            echo "üí° Tips:"
            echo "   - First time? Run: ./setup.sh"
            echo "   - Already set up? Run: task sync"
            echo "   - See all tasks: task -l"
          else
            echo "  ‚ö†Ô∏è  $FAILURES critical check(s) failed"
            echo ""
            echo "üí° Next steps:"
            echo "   - Install missing dependencies"
            echo "   - Run ./setup.sh to complete bootstrap"
            exit 1
          fi

  banner:
    internal: true
    desc: shows an animated banner
    silent: true
    cmds:
      - cmd: clear
      - cmd: ./scripts/banner.sh
      # new line
      - cmd: echo ''
