name: CI

on:
  push:
    branches: [master]
  pull_request:

jobs:
  yaml-lint:
    name: 'Lint: Yaml'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: karancode/yamllint-github-action@v2.0.0
        with:
          yamllint_file_or_dir: '.'
          yamllint_strict: true
          yamllint_config_filepath: config/yamllint/config

  lua-formatting:
    name: 'Format: Lua'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run stylua check
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: v2.0.2
          args: --check .

  lua-diagnotics:
    name: 'Diagnostics: Lua'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ASDF
        uses: asdf-vm/actions/setup@v1

      - name: ASDF Plugin Add
        run: |
          asdf plugin add neovim https://github.com/richin13/asdf-neovim.git

      - name: ASDF Install
        uses: asdf-vm/actions/install@v1

      - name: Run Diagnostics Check
        run: |
          # Use Neovim to check lua syntax (has vim global in runtime)
          find config/nvim/lua -name "*.lua" -exec nvim --headless -u NONE -c "luafile {}" -c "quit" \; 2>&1 | grep -i error || true

  shell-lint:
    name: 'Lint: Shell'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@b2bbefc2e6b9dcbc6355b85e366c9e55bf8d57e1
        with:
          ignore_paths: './iterm/TerminalVim.app/'
          ignore_names: '*/**/*.zsh zshrc'

  spelling:
    name: 'Lint: Spelling'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check spelling in code
        # yamllint disable-line rule:line-length
        uses: codespell-project/actions-codespell@2391250ab05295bddd51e36a8c6295edb6343b0e
        with:
          skip: docs

  brewfile-lint:
    name: 'Lint: Brewfile'

    runs-on: macos-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Brewfile syntax
        run: brew bundle check || true

  taskfile-lint:
    name: 'Lint: Taskfile'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Validate Taskfile
        run: task --list

  installation-test:
    name: 'Test: Installation Scripts'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test setup script syntax
        run: bash -n setup.sh

      - name: Test installer scripts
        run: |
          find installer -type f -name "*.sh" | while read -r script; do
            echo "Checking $script..."
            bash -n "$script"
          done

  editorconfig-lint:
    name: 'Lint: EditorConfig'

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check EditorConfig compliance
        uses: editorconfig-checker/action-editorconfig-checker@main

      - name: Show EditorConfig violations
        if: failure()
        run: editorconfig-checker
